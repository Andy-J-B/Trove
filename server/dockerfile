# ---------- Build Stage ----------
FROM node:20-alpine AS builder
WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source files
COPY src ./src
COPY prisma ./prisma
COPY routes ./routes
COPY server.ts ./

# Generate Prisma client
RUN npx prisma generate

# Install tsx globally (for running TS directly)
RUN npm install -g tsx

# Expose port and set env
EXPOSE 3000
ENV NODE_ENV=production

# Run the app directly with tsx
CMD ["tsx", "server.ts"]